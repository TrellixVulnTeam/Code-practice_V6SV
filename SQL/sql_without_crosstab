-- https://www.codewars.com/kata/5982020284a83baf2f00001c
-- SQL Basics: Simple PIVOTING data WITHOUT CROSSTAB

-- Solution 1

WITH good AS (SELECT p.name,
        d.detail,
        COUNT(d.*)
FROM products p
JOIN details d
ON p.id = d.product_id
GROUP BY p.name, d.detail
HAVING d.detail = 'good'),

ok AS (SELECT p.name,
        d.detail,
        COUNT(d.*)
FROM products p
JOIN details d
ON p.id = d.product_id
GROUP BY p.name, d.detail
HAVING d.detail = 'ok'),

bad AS (SELECT p.name,
        d.detail,
        COUNT(d.*)
FROM products p
JOIN details d
ON p.id = d.product_id
GROUP BY p.name, d.detail
HAVING d.detail = 'bad')

SELECT good.name,
      CASE detail WHEN 'good' THEN count END AS good,
      ok,
      bad
FROM good
INNER JOIN (SELECT name,
      CASE detail WHEN 'ok' THEN count END AS ok
FROM ok) AS ok
ON good.name = ok.name
INNER JOIN (SELECT name,
      CASE detail WHEN 'bad' THEN count END AS bad
FROM bad) AS bad
ON good.name = bad.name; 

-- Solution 2

SELECT p.name,
       COUNT(*) FILTER(WHERE d.detail = 'good') AS good,
       COUNT(*) FILTER(WHERE d.detail = 'ok') AS ok,
       COUNT(*) FILTER(WHERE d.detail = 'bad') AS bad
FROM products p
JOIN details d
ON p.id = d.product_id
GROUP BY p.name
ORDER BY p.name;

https://kb.objectrocket.com/postgresql/how-to-use-the-filter-clause-in-postgresql-881
