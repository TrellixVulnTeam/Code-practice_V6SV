# Analyzing the sales by product and date
# https://www.codewars.com/kata/5dac87a0abe9f1001f39e36d

SELECT p.name AS product_name,
      NULL::integer AS year,
      NULL::integer AS month,
      NULL::integer AS day,
      SUM(p.price*sd.count) as total 
FROM sales_details sd
LEFT JOIN products p
ON sd.product_id = p.id
JOIN sales ss
ON sd.sale_id = ss.id
GROUP BY product_name

UNION

SELECT p.name AS product_name,
      extract(year FROM ss.date)::integer AS year,
      NULL::integer AS month,
      NULL::integer AS day,
      SUM(p.price*sd.count) as total 
FROM sales_details sd
LEFT JOIN products p
ON sd.product_id = p.id
LEFT JOIN sales ss
ON sd.sale_id = ss.id
GROUP BY product_name, year

UNION

SELECT p.name AS product_name,
      extract(year FROM ss.date)::integer AS year,
      extract(month FROM ss.date)::integer AS month,
      NULL::integer AS day,
      SUM(p.price*sd.count) as total 
FROM sales_details sd
LEFT JOIN products p
ON sd.product_id = p.id
LEFT JOIN sales ss
ON sd.sale_id = ss.id
GROUP BY product_name, year, month

UNION

SELECT p.name AS product_name,
      extract(year FROM ss.date)::integer AS year,
      extract(month FROM ss.date)::integer AS month,
      extract(day FROM ss.date)::integer AS day,
      SUM(p.price*sd.count) as total 
FROM sales_details sd
LEFT JOIN products p
ON sd.product_id = p.id
LEFT JOIN sales ss
ON sd.sale_id = ss.id
GROUP BY product_name, year, month, day
ORDER BY product_name, year, month, day;


# another solution

select
  name as product_name,
  extract(year from date)::int as year,
  extract(month from date)::int as month,
  extract(day from date)::int as day,
  sum(price * count) as total
from sales_details sd
join sales s on sd.sale_id = s.id
join products p on sd.product_id = p.id
group by name, rollup(year, month, day)
order by product_name, year, month, day
